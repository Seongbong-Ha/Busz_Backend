# ğŸšŒ Busz Backend

ì‹œê°ì¥ì• ì¸ ë²„ìŠ¤ íƒ‘ìŠ¹ ì§€ì› ì‹œìŠ¤í…œì˜ ë°±ì—”ë“œ ì„œë²„ (ë°ì´í„° í—ˆë¸Œ)

## ğŸ“‹ ê°œìš”

Busz Backendì€ ì‹¤ì‹œê°„ ë²„ìŠ¤ ì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ê³  ê°€ê³µí•˜ì—¬ ëª¨ë°”ì¼ ì•±ì— ì œê³µí•˜ëŠ” **ë°ì´í„° í—ˆë¸Œ** ì—­í• ì„ ë‹´ë‹¹í•©ë‹ˆë‹¤.

### ğŸ—ï¸ ì•„í‚¤í…ì²˜
```
ğŸ“± ëª¨ë°”ì¼ ì•±              ğŸ–¥ï¸ ë°±ì—”ë“œ ì„œë²„              ğŸšŒ ê³µê³µ API
    â†“                       â†“                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ì‚¬ìš©ì ê²½í—˜  â”‚ â†â†’   â”‚   ë°ì´í„° í—ˆë¸Œ    â”‚ â†â†’   â”‚ TAGO API     â”‚
â”‚ â€¢ UI/UX     â”‚      â”‚ â€¢ ì‹¤ì‹œê°„ ìˆ˜ì§‘   â”‚      â”‚ â€¢ BIS API    â”‚
â”‚ â€¢ ìŒì„±ì²˜ë¦¬  â”‚      â”‚ â€¢ ë°ì´í„° ê°€ê³µ   â”‚      â”‚ â€¢ êµí†µì •ë³´   â”‚
â”‚ â€¢ ì„¼ì„œí™œìš©  â”‚      â”‚ â€¢ ì„¸ì…˜ ê´€ë¦¬     â”‚      â”‚              â”‚
â”‚ â€¢ í–…í‹±ì œì–´  â”‚      â”‚ â€¢ ìƒíƒœ ì¶”ì      â”‚      â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ API ëª…ì„¸ì„œ

### ğŸŒ ì„œë²„ ì •ë³´
- **Base URL**: `http://localhost:8000` (ê°œë°œí™˜ê²½)
- **Protocol**: HTTP/HTTPS + WebSocket
- **Data Format**: JSON
- **CORS**: ëª¨ë“  Origin í—ˆìš© (ê°œë°œí™˜ê²½)

### ğŸ”„ í†µì‹  í”Œë¡œìš°

#### **ì „ì²´ ì‚¬ìš© íë¦„**
```
1. WebSocket ì—°ê²° â†’ ìë™ìœ¼ë¡œ connected ì´ë²¤íŠ¸ ìˆ˜ì‹ 
2. í”Œë¡œìš° 1: start_bus_monitoring ì „ì†¡ â†’ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì‹œì‘
3. í”Œë¡œìš° 2: POST /api/station/buses â†’ ì „ì²´ ë²„ìŠ¤ ì •ë³´ ì¡°íšŒ
4. ì‚¬ìš©ìê°€ ì›í•˜ëŠ” ì‹œì ì— stop_bus_monitoring ì „ì†¡
```

---

## ğŸ”Œ WebSocket API (í”Œë¡œìš° 1: ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§)

### ì—°ê²° ì •ë³´
- **URL**: `ws://localhost:8000`
- **Protocol**: Socket.IO

### ğŸ”„ **ì´ë²¤íŠ¸ í”Œë¡œìš°**

#### **1ë‹¨ê³„: ì—°ê²° (ìë™)**
```kotlin
// ì•ˆë“œë¡œì´ë“œì—ì„œ ì—°ê²°ë§Œ í•˜ë©´
socket = IO.socket("https://your-server-url")
socket.connect()
```

#### **2ë‹¨ê³„: ì—°ê²° í™•ì¸ (ìë™ ìˆ˜ì‹ )**
```json
// ì„œë²„ê°€ ìë™ìœ¼ë¡œ ì „ì†¡í•˜ëŠ” ì´ë²¤íŠ¸
{
    "message": "ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤",
    "session_id": "abc123def456"  // âš ï¸ ì¤‘ìš”: í”Œë¡œìš° 2ì—ì„œ ì‚¬ìš©
}
```

#### **3ë‹¨ê³„: ëª¨ë‹ˆí„°ë§ ì‹œì‘ (ìˆ˜ë™ ì „ì†¡)**
```json
// ì•±ì—ì„œ ì§ì ‘ ì „ì†¡í•´ì•¼ í•˜ëŠ” ì´ë²¤íŠ¸
{
    "lat": 37.497928,        // ìœ„ë„ (í•„ìˆ˜)
    "lng": 127.027583,       // ê²½ë„ (í•„ìˆ˜)  
    "bus_number": "9201",    // ëª¨ë‹ˆí„°ë§í•  ë²„ìŠ¤ ë²ˆí˜¸ (í•„ìˆ˜)
    "interval": 30           // ì—…ë°ì´íŠ¸ ê°„ê²©(ì´ˆ), ê¸°ë³¸ 30ì´ˆ
}
```

#### **4ë‹¨ê³„: ëª¨ë‹ˆí„°ë§ ì‹œì‘ í™•ì¸ (ìë™ ì‘ë‹µ)**
```json
// ì„œë²„ê°€ ìë™ìœ¼ë¡œ ì‘ë‹µí•˜ëŠ” ì´ë²¤íŠ¸
{
    "message": "9201ë²ˆ ë²„ìŠ¤ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ì„ ì‹œì‘í•©ë‹ˆë‹¤",
    "bus_number": "9201",
    "interval": 30,
    "session_id": "abc123def456"
}
```

#### **5ë‹¨ê³„: ì‹¤ì‹œê°„ ë²„ìŠ¤ ì •ë³´ (ìë™, ì£¼ê¸°ì )**
30ì´ˆë§ˆë‹¤ ìë™ìœ¼ë¡œ ì „ì†¡ë˜ëŠ” ì´ë²¤íŠ¸:

**ë²„ìŠ¤ ë°œê²¬ëœ ê²½ìš°:**
```json
{
    "timestamp": "2025-01-10T15:30:45.123456",
    "bus_found": true,
    "station_name": "ê°•ë‚¨ì—­",
    "station_id": "station123", 
    "bus_number": "9201",
    "arrival_time": 180,                    // ì´ˆ ë‹¨ìœ„
    "arrival_time_formatted": "3ë¶„",
    "remaining_stations": 2,
    "vehicle_type": "ì¼ë°˜ë²„ìŠ¤",
    "route_type": "ê°„ì„ ë²„ìŠ¤"
}
```

**ë²„ìŠ¤ ëª» ì°¾ì€ ê²½ìš°:**
```json
{
    "timestamp": "2025-01-10T15:30:45.123456",
    "bus_found": false,
    "station_name": "ê°•ë‚¨ì—­",
    "bus_number": "9201", 
    "message": "9201ë²ˆ ë²„ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
}
```

### ğŸ“¤ **ì•±ì—ì„œ ì „ì†¡í•˜ëŠ” ì´ë²¤íŠ¸ë“¤**

| ì´ë²¤íŠ¸ëª… | íƒ€ì´ë° | ë§¤ê°œë³€ìˆ˜ | ì„¤ëª… |
|---------|--------|----------|------|
| `start_bus_monitoring` | ìˆ˜ë™ | lat, lng, bus_number, interval | ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì‹œì‘ |
| `stop_bus_monitoring` | ìˆ˜ë™ | ì—†ìŒ | ëª¨ë‹ˆí„°ë§ ì¤‘ë‹¨ |
| `get_session_status` | ìˆ˜ë™ | ì—†ìŒ | í˜„ì¬ ìƒíƒœ í™•ì¸ |

### ğŸ“¥ **ì„œë²„ì—ì„œ ì „ì†¡í•˜ëŠ” ì´ë²¤íŠ¸ë“¤**

| ì´ë²¤íŠ¸ëª… | íƒ€ì´ë° | ì„¤ëª… |
|---------|--------|------|
| `connected` | ì—°ê²° ì‹œ ìë™ | ì—°ê²° ì™„ë£Œ + session_id ì œê³µ |
| `monitoring_started` | start_bus_monitoring ì‘ë‹µ | ëª¨ë‹ˆí„°ë§ ì‹œì‘ í™•ì¸ |
| `bus_update` | 30ì´ˆë§ˆë‹¤ ìë™ | ì‹¤ì‹œê°„ ë²„ìŠ¤ ì •ë³´ |
| `monitoring_stopped` | stop_bus_monitoring ì‘ë‹µ | ëª¨ë‹ˆí„°ë§ ì¤‘ë‹¨ í™•ì¸ |
| `session_status` | get_session_status ì‘ë‹µ | í˜„ì¬ ì„¸ì…˜ ìƒíƒœ |
| `error` | ì—ëŸ¬ ë°œìƒ ì‹œ | ì—ëŸ¬ ë©”ì‹œì§€ |

---

## ğŸŒ REST API (í”Œë¡œìš° 2: ì „ì²´ ë²„ìŠ¤ ì •ë³´)

### POST `/api/station/buses` - ì „ì²´ ë²„ìŠ¤ ì •ë³´ ì¡°íšŒ

**âš ï¸ ì¤‘ìš” ì „ì œì¡°ê±´**: 
1. WebSocketì´ ì—°ê²°ë˜ì–´ ìˆì–´ì•¼ í•¨
2. í”Œë¡œìš° 1ì´ ì‹¤í–‰ ì¤‘ì´ì–´ì•¼ í•¨ (`start_bus_monitoring` ì´ë²¤íŠ¸ ì „ì†¡ ì™„ë£Œ)

#### ğŸ“¤ ì•± â†’ ì„œë²„ ìš”ì²­ í˜•ì‹
```http
POST /api/station/buses
Content-Type: application/json
X-Session-ID: abc123def456  â† WebSocket connected ì´ë²¤íŠ¸ì—ì„œ ë°›ì€ session_id

{}  â† ë¹ˆ JSON ê°ì²´ ì „ì†¡
```

#### ğŸ“¥ ì„œë²„ â†’ ì•± ì‘ë‹µ í˜•ì‹

**ì„±ê³µ ì‘ë‹µ (200):**
```json
{
    "success": true,
    "timestamp": "2025-01-10T15:30:45.123456",
    "station": {
        "station_name": "ê°•ë‚¨ì—­",
        "latitude": 37.497928,
        "longitude": 127.027583,
        "distance_from_user": 25
    },
    "buses": [
        {
            "route_name": "9201",
            "arrival_time": 180      // ì´ˆ ë‹¨ìœ„
        },
        {
            "route_name": "146", 
            "arrival_time": 420
        }
    ],
    "total_count": 2
}
```

**ì—ëŸ¬ ì‘ë‹µ (401) - ì„¸ì…˜ ì—†ìŒ:**
```json
{
    "success": false,
    "error": "í™œì„± ëª¨ë‹ˆí„°ë§ ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤. í”Œë¡œìš° 1ì„ ë¨¼ì € ì‹œì‘í•´ì£¼ì„¸ìš”.",
    "error_code": "NO_ACTIVE_SESSION"
}
```

---

## ğŸ’¡ ì‹¤ì œ ì‚¬ìš© ì˜ˆì‹œ

### ğŸ”„ **ì•ˆë“œë¡œì´ë“œ êµ¬í˜„ ì˜ˆì‹œ**

```kotlin
class BusService {
    private lateinit var socket: Socket
    private var sessionId: String? = null
    
    // 1. WebSocket ì—°ê²°
    fun connectWebSocket() {
        socket = IO.socket("https://your-server-url")
        
        // ìë™ìœ¼ë¡œ ìˆ˜ì‹ ë˜ëŠ” ì´ë²¤íŠ¸ë“¤
        socket.on("connected") { args ->
            val data = args[0] as Map<String, Any>
            sessionId = data["session_id"] as String
            Log.d("Socket", "âœ… ì—°ê²° ì™„ë£Œ, ì„¸ì…˜ ID: $sessionId")
        }
        
        socket.on("monitoring_started") { args ->
            Log.d("Socket", "âœ… ëª¨ë‹ˆí„°ë§ ì‹œì‘ë¨")
        }
        
        socket.on("bus_update") { args ->
            val data = args[0] as Map<String, Any>
            processBusUpdate(data)
        }
        
        socket.connect()
    }
    
    // 2. í”Œë¡œìš° 1: ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì‹œì‘
    fun startMonitoring(lat: Double, lng: Double, busNumber: String) {
        val data = mapOf(
            "lat" to lat,
            "lng" to lng,
            "bus_number" to busNumber,
            "interval" to 30
        )
        
        socket.emit("start_bus_monitoring", data)
    }
    
    // 3. í”Œë¡œìš° 2: ì „ì²´ ë²„ìŠ¤ ì •ë³´ ì¡°íšŒ
    suspend fun getAllBuses(): List<Bus> {
        val client = OkHttpClient()
        val request = Request.Builder()
            .url("https://your-server-url/api/station/buses")
            .post("{}".toRequestBody("application/json".toMediaType()))
            .addHeader("X-Session-ID", sessionId ?: "")
            .build()
            
        val response = client.newCall(request).execute()
        // JSON íŒŒì‹± í›„ ë²„ìŠ¤ ëª©ë¡ ë°˜í™˜
    }
}
```

### ğŸ“± **ì¶”ì²œ ì‚¬ìš© íŒ¨í„´**

1. **ì•± ì‹œì‘ ì‹œ**: WebSocket ì—°ê²° â†’ `session_id` ì €ì¥
2. **ìŒì„± ì¸ì‹ í›„**: `start_bus_monitoring` ì „ì†¡
3. **í•„ìš” ì‹œ**: REST APIë¡œ ì „ì²´ ë²„ìŠ¤ ëª©ë¡ ì¡°íšŒ
4. **ì•± ì¢…ë£Œ ì‹œ**: `stop_bus_monitoring` ì „ì†¡

---

## ğŸ”§ ê°œë°œ í™˜ê²½

### ì˜ì¡´ì„±
- **Python**: 3.8+
- **Flask**: 3.1.1
- **Flask-SocketIO**: WebSocket ì§€ì›
- **Flask-CORS**: ëª¨ë°”ì¼ ì•± ì—°ë™
- **requests**: HTTP API í˜¸ì¶œ

### ì‚¬ìš© ì¤‘ì¸ ì™¸ë¶€ API
- **TAGO API**: ì „êµ­ ë²„ìŠ¤ ì •ë³´ (ì„œìš¸ ì œì™¸)

### í˜„ì¬ ì œí•œì‚¬í•­
- ì„œìš¸ ì§€ì—­ ì„œë¹„ìŠ¤ ì œì™¸ (BIS API ì´ìŠˆ)
- TAGO API í‚¤ í•„ìš” (ê³µê³µë°ì´í„°í¬í„¸ì—ì„œ ë°œê¸‰)

---

## â“ ìì£¼ ë¬»ëŠ” ì§ˆë¬¸

**Q: WebSocket ì—°ê²°ë§Œ í•˜ë©´ ìë™ìœ¼ë¡œ ë°ì´í„°ê°€ ì˜¤ë‚˜ìš”?**
A: ì•„ë‹ˆìš”. ì—°ê²° ì‹œ `connected` ì´ë²¤íŠ¸ë§Œ ìë™ìœ¼ë¡œ ì˜¤ê³ , ì‹¤ì œ ë²„ìŠ¤ ì •ë³´ë¥¼ ë°›ìœ¼ë ¤ë©´ `start_bus_monitoring` ì´ë²¤íŠ¸ë¥¼ ì „ì†¡í•´ì•¼ í•©ë‹ˆë‹¤.

**Q: í”Œë¡œìš° 2ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ë°˜ë“œì‹œ í”Œë¡œìš° 1ì´ ì‹¤í–‰ ì¤‘ì´ì–´ì•¼ í•˜ë‚˜ìš”?**
A: ë„¤, í”Œë¡œìš° 2ëŠ” í”Œë¡œìš° 1ì—ì„œ ìƒì„±ëœ ì„¸ì…˜ ì •ë³´ë¥¼ í™œìš©í•©ë‹ˆë‹¤.

**Q: session_idëŠ” ì–¸ì œ ë°›ì„ ìˆ˜ ìˆë‚˜ìš”?**
A: WebSocket ì—°ê²° ì§í›„ `connected` ì´ë²¤íŠ¸ì—ì„œ ìë™ìœ¼ë¡œ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.