# ğŸšŒ Busz Backend

ì‹œê°ì¥ì• ì¸ ë²„ìŠ¤ íƒ‘ìŠ¹ ì§€ì› ì‹œìŠ¤í…œì˜ ë°±ì—”ë“œ ì„œë²„ (ë°ì´í„° í—ˆë¸Œ)

## ğŸ“‹ ê°œìš”

Busz Backendì€ ì‹¤ì‹œê°„ ë²„ìŠ¤ ì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ê³  ê°€ê³µí•˜ì—¬ ëª¨ë°”ì¼ ì•±ì— ì œê³µí•˜ëŠ” **ë°ì´í„° í—ˆë¸Œ** ì—­í• ì„ ë‹´ë‹¹í•©ë‹ˆë‹¤.

### ğŸ—ï¸ ì•„í‚¤í…ì²˜
```
ğŸ“± ëª¨ë°”ì¼ ì•±              ğŸ–¥ï¸ ë°±ì—”ë“œ ì„œë²„              ğŸšŒ ê³µê³µ API
    â†“                       â†“                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ì‚¬ìš©ì ê²½í—˜  â”‚ â†â†’   â”‚   ë°ì´í„° í—ˆë¸Œ    â”‚ â†â†’   â”‚ TAGO API     â”‚
â”‚ â€¢ CV ì²˜ë¦¬   â”‚      â”‚ â€¢ ì‹¤ì‹œê°„ ìˆ˜ì§‘   â”‚      â”‚ â€¢ BIS API    â”‚
â”‚ â€¢ ìŒì„±ì²˜ë¦¬  â”‚      â”‚ â€¢ ë°ì´í„° ê°€ê³µ   â”‚      â”‚ â€¢ êµí†µì •ë³´   â”‚
â”‚ â€¢ ì„¼ì„œí™œìš©  â”‚      â”‚ â€¢ ì„¸ì…˜ ê´€ë¦¬     â”‚      â”‚              â”‚
â”‚ â€¢ í–…í‹±ì œì–´  â”‚      â”‚ â€¢ ìƒíƒœ ì¶”ì      â”‚      â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ API ëª…ì„¸ì„œ

### ğŸŒ ì„œë²„ ì •ë³´
- **Base URL**: `http://localhost:5000` (ê°œë°œí™˜ê²½)
- **Protocol**: HTTP/HTTPS + WebSocket
- **Data Format**: JSON
- **CORS**: ëª¨ë“  Origin í—ˆìš© (ê°œë°œí™˜ê²½)

### ğŸ”„ í†µì‹  í”Œë¡œìš°

#### **ì „ì²´ ì‚¬ìš© íë¦„**
```
1. WebSocket ì—°ê²°
2. í”Œë¡œìš° 1: start_bus_monitoring (ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì‹œì‘)
3. í”Œë¡œìš° 2: POST /api/station/buses (ì „ì²´ ë²„ìŠ¤ ì •ë³´ ì¡°íšŒ)
4. ì‚¬ìš©ìê°€ ì›í•˜ëŠ” ì‹œì ì— stop_bus_monitoring
```

---

## ğŸ”Œ WebSocket API (í”Œë¡œìš° 1: ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§)

### ì—°ê²° ì •ë³´
- **URL**: `ws://localhost:5000`
- **Protocol**: Socket.IO

### ğŸ“¤ ì•± â†’ ì„œë²„ JSON í˜•ì‹

#### `start_bus_monitoring` - ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì‹œì‘
```json
{
    "lat": 37.497928,        // ìœ„ë„ (í•„ìˆ˜)
    "lng": 127.027583,       // ê²½ë„ (í•„ìˆ˜)  
    "bus_number": "9201",    // ëª¨ë‹ˆí„°ë§í•  ë²„ìŠ¤ ë²ˆí˜¸ (í•„ìˆ˜)
    "interval": 30           // ì—…ë°ì´íŠ¸ ê°„ê²©(ì´ˆ), ê¸°ë³¸ 30ì´ˆ
}
```

#### `stop_bus_monitoring` - ëª¨ë‹ˆí„°ë§ ì¤‘ë‹¨
```json
// ë¹ˆ ì´ë²¤íŠ¸ (ë°ì´í„° ì—†ìŒ)
```

#### `get_session_status` - í˜„ì¬ ìƒíƒœ í™•ì¸
```json
// ë¹ˆ ì´ë²¤íŠ¸ (ë°ì´í„° ì—†ìŒ)
```

### ğŸ“¥ ì„œë²„ â†’ ì•± JSON í˜•ì‹

#### `connected` - ì—°ê²° ì™„ë£Œ
```json
{
    "message": "ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤",
    "session_id": "abc123def456"  // âš ï¸ ì¤‘ìš”: REST APIì—ì„œ ì‚¬ìš©
}
```

#### `monitoring_started` - ëª¨ë‹ˆí„°ë§ ì‹œì‘ë¨
```json
{
    "message": "9201ë²ˆ ë²„ìŠ¤ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ì„ ì‹œì‘í•©ë‹ˆë‹¤",
    "bus_number": "9201",
    "interval": 30,
    "session_id": "abc123def456"
}
```

#### `bus_update` - ì‹¤ì‹œê°„ ë²„ìŠ¤ ì •ë³´ (í•µì‹¬!)

**ë²„ìŠ¤ ë°œê²¬ëœ ê²½ìš°:**
```json
{
    "timestamp": "2025-01-10T15:30:45.123456",
    "bus_found": true,
    "station_name": "ê°•ë‚¨ì—­",
    "station_id": "station123",
    "bus_number": "9201",
    "arrival_time": 180,                    // ì´ˆ ë‹¨ìœ„
    "arrival_time_formatted": "3ë¶„",
    "remaining_stations": 2,
    "vehicle_type": "ì¼ë°˜ë²„ìŠ¤",
    "route_type": "ê°„ì„ ë²„ìŠ¤", 
    "urgency": "moderate",                  // "urgent", "moderate", "normal"
    "voice_message": "ì¡°ê¸ˆ ê¸°ë‹¤ë¦¬ì‹œë©´ 9201ë²ˆ ë²„ìŠ¤ê°€ 3ë¶„ í›„ì— ë„ì°©í•©ë‹ˆë‹¤.",
    "total_buses": 1
}
```

**ë²„ìŠ¤ ëª» ì°¾ì€ ê²½ìš°:**
```json
{
    "timestamp": "2025-01-10T15:30:45.123456",
    "bus_found": false,
    "station_name": "ê°•ë‚¨ì—­", 
    "station_id": "station123",
    "bus_number": "9201",
    "message": "9201ë²ˆ ë²„ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
}
```

**ì—ëŸ¬ ë°œìƒí•œ ê²½ìš°:**
```json
{
    "timestamp": "2025-01-10T15:30:45.123456",
    "error": "ë²„ìŠ¤ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨: TAGO API ì˜¤ë¥˜"
}
```

#### `monitoring_stopped` - ëª¨ë‹ˆí„°ë§ ì¤‘ë‹¨ë¨
```json
{
    "message": "ë²„ìŠ¤ ëª¨ë‹ˆí„°ë§ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤",
    "session_id": "abc123def456"
}
```

#### `session_status` - ì„¸ì…˜ ìƒíƒœ ì‘ë‹µ
```json
{
    "active": true,
    "bus_number": "9201",
    "interval": 30,
    "session_id": "abc123def456"
}
```

#### `error` - ì—ëŸ¬ ë°œìƒ
```json
{
    "message": "ìœ„ë„, ê²½ë„, ë²„ìŠ¤ë²ˆí˜¸ê°€ ëª¨ë‘ í•„ìš”í•©ë‹ˆë‹¤"
}
```

---

## ğŸŒ REST API (í”Œë¡œìš° 2: ì „ì²´ ë²„ìŠ¤ ì •ë³´)

### POST `/api/station/buses` - ì „ì²´ ë²„ìŠ¤ ì •ë³´ ì¡°íšŒ

**âš ï¸ ì¤‘ìš”**: í”Œë¡œìš° 1(WebSocket ëª¨ë‹ˆí„°ë§)ì´ ë¨¼ì € ì‹¤í–‰ë˜ì–´ì•¼ í•©ë‹ˆë‹¤!

#### ğŸ“¤ ì•± â†’ ì„œë²„ ìš”ì²­ í˜•ì‹
```http
POST /api/station/buses
Content-Type: application/json
X-Session-ID: abc123def456

{}
```

#### ğŸ“¥ ì„œë²„ â†’ ì•± ì‘ë‹µ í˜•ì‹

**ì„±ê³µ ì‘ë‹µ (200):**
```json
{
    "success": true,
    "timestamp": "2025-01-10T15:30:45.123456",
    "station": {
        "station_name": "ê°•ë‚¨ì—­",
        "latitude": 37.497928,
        "longitude": 127.027583,
        "distance_from_user": 25
    },
    "buses": [
        {
            "route_name": "9201",
            "arrival_time": 180
        },
        {
            "route_name": "146",
            "arrival_time": 420
        }
    ],
    "total_count": 2
}
```

**ì—ëŸ¬ ì‘ë‹µ (401) - ì„¸ì…˜ ì—†ìŒ:**
```json
{
    "success": false,
    "error": "í™œì„± ëª¨ë‹ˆí„°ë§ ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤. í”Œë¡œìš° 1ì„ ë¨¼ì € ì‹œì‘í•´ì£¼ì„¸ìš”.",
    "error_code": "NO_ACTIVE_SESSION",
    "timestamp": "2025-01-10T15:30:45.123456"
}
```

**ì—ëŸ¬ ì‘ë‹µ (503) - API ì˜¤ë¥˜:**
```json
{
    "success": false,
    "error": "ë²„ìŠ¤ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨: TAGO API ì˜¤ë¥˜",
    "error_code": "TAGO_API_ERROR",
    "timestamp": "2025-01-10T15:30:45.123456"
}
```

---

## ğŸ“‹ ê¸°íƒ€ ì—”ë“œí¬ì¸íŠ¸

### GET `/` - ì„œë²„ ìƒíƒœ í™•ì¸
```json
{
    "success": true,
    "message": "Busz Backend API ì„œë²„",
    "status": "running",
    "version": "v1.0.0",
    "mobile_app_ready": true
}
```

### GET `/api` - API ì •ë³´
```json
{
    "success": true,
    "api_version": "v1.0.0",
    "flows": {
        "flow1": {
            "type": "WebSocket",
            "description": "íŠ¹ì • ë²„ìŠ¤ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§"
        },
        "flow2": {
            "type": "REST API", 
            "description": "ì „ì²´ ë²„ìŠ¤ ì •ë³´ ì¡°íšŒ (ì„¸ì…˜ ê¸°ë°˜)"
        }
    }
}
```

---

## ğŸ’¡ ë°ì´í„° í™œìš© ê°€ì´ë“œ

### ğŸ”‘ ì¤‘ìš”í•œ í•„ë“œë“¤

- **session_id**: WebSocket ì—°ê²° ì‹œ ë°›ì•„ì„œ REST API í—¤ë”ì— ì‚¬ìš©
- **voice_message**: ë°”ë¡œ TTSë¡œ ìŒì„± ì•ˆë‚´ ê°€ëŠ¥
- **urgency**: ì•Œë¦¼ ê°•ë„ ì¡°ì ˆ
  - `"urgent"` (5ë¶„ ì´ë‚´) â†’ ê°•í•œ ì•Œë¦¼/ì§„ë™
  - `"moderate"` (5-10ë¶„) â†’ ë³´í†µ ì•Œë¦¼
  - `"normal"` (10ë¶„ ì´ìƒ) â†’ ì•½í•œ ì•Œë¦¼
- **arrival_time**: ì´ˆ ë‹¨ìœ„ (ë¶„ ë³€í™˜: `arrival_time / 60`)
- **bus_found**: falseë©´ ë‹¤ë¥¸ ë²„ìŠ¤ ì¶”ì²œ ë¡œì§ ì‹¤í–‰

### ğŸ“± ì¶”ì²œ ì‚¬ìš© íŒ¨í„´

1. **WebSocket ì—°ê²°** â†’ `session_id` ì €ì¥
2. **í”Œë¡œìš° 1 ì‹œì‘** â†’ ì‹¤ì‹œê°„ ìŒì„± ì•ˆë‚´
3. **í•„ìš”ì‹œ í”Œë¡œìš° 2** â†’ ì „ì²´ ë²„ìŠ¤ ëª©ë¡ í™•ì¸
4. **ì ì ˆí•œ ì‹œì ì— ëª¨ë‹ˆí„°ë§ ì¤‘ë‹¨**

---

## ğŸ”§ ê°œë°œ í™˜ê²½

### ì˜ì¡´ì„±
- **Python**: 3.8+
- **Flask**: 3.1.1
- **Flask-SocketIO**: WebSocket ì§€ì›
- **Flask-CORS**: ëª¨ë°”ì¼ ì•± ì—°ë™
- **requests**: HTTP API í˜¸ì¶œ

### ì‚¬ìš© ì¤‘ì¸ ì™¸ë¶€ API
- **TAGO API**: ì „êµ­ ë²„ìŠ¤ ì •ë³´ (ì„œìš¸ ì œì™¸)

### í˜„ì¬ ì œí•œì‚¬í•­
- ì„œìš¸ ì§€ì—­ ì„œë¹„ìŠ¤ ì œì™¸ (BIS API ì´ìŠˆ)
- TAGO API í‚¤ í•„ìš” (ê³µê³µë°ì´í„°í¬í„¸ì—ì„œ ë°œê¸‰)